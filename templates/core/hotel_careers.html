{% extends "base.html" %}
{% load static %}

{% block title %}Careers | {{ hotel.name }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/career_card.css' %}">
<style>
    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .modal-header {
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
        background-color: #aa9050 !important;
    }

    .modal-header .modal-title {
        color: white;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }

    .modal-footer {
        border-radius: 0 0 12px 12px;
        padding: 1rem 1.5rem;
    }

    /* Form Styles */
    .form-floating > .form-control {
        padding: 1rem 0.75rem;
        height: calc(3.5rem + 2px);
        line-height: 1.25;
    }

    .form-floating > textarea.form-control {
        height: 120px;
    }

    .form-floating > label {
        padding: 1rem 0.75rem;
    }

    /* File Upload Styles */
    .file-upload-wrapper {
        position: relative;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
        cursor: pointer;
    }

    .file-upload-wrapper:hover {
        border-color: #0d6efd;
        background: #f1f8ff;
    }

    .file-upload-wrapper.dragover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }

    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-upload-icon {
        font-size: 2.5rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .file-upload-text {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .file-upload-subtext {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .file-selected {
        display: none;
        align-items: center;
        gap: 0.5rem;
        color: #198754;
        font-weight: 500;
    }

    .file-selected i {
        font-size: 1.25rem;
    }

    /* Toast Styles */
    .toast-custom {
        background: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
    }

    .toast-success {
        border-left: 4px solid #198754;
    }

    .toast-error {
        border-left: 4px solid #dc3545;
    }

    .toast-icon {
        font-size: 1.25rem;
    }

    .toast-success .toast-icon {
        color: #198754;
    }

    .toast-error .toast-icon {
        color: #dc3545;
    }

    /* Button Styles */
    .btn {
        padding: 0.5rem 1.25rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        background: #0b5ed7;
        border-color: #0b5ed7;
        transform: translateY(-1px);
    }

    .btn-outline-secondary {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-outline-secondary:hover {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
        transform: translateY(-1px);
    }

    /* Loading Spinner */
    .spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}
{% block content %}

<!-- Header Banner -->
{% if banner and banner.image %}
<section class="banner-header bg-img bg-fixed" data-overlay-dark="5"
         data-background="{{ banner.image.url }}"
         style="padding: 150px 0; min-height: 650px;">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <div class="subtitle">{{ hotel.name }}</div>
                <div class="title">Careers</div>
            </div>
        </div>
    </div>
</section>
{% endif %}
<!-- Careers Section -->
<div class="container mt-5">
  <div class="row">
    {% for career in careers %}
      <div class="col-md-6 mb-4">
        {% include "includes/career_card.html" with career=career %}
      </div>
    {% empty %}
      <div class="col-12">
        <p>No career opportunities available right now.</p>
      </div>
    {% endfor %}
  </div>
</div>
<!-- Enhanced Career Application Modal -->
<div class="modal fade" id="applyModal" tabindex="-1" aria-labelledby="applyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="careerForm" method="post" enctype="multipart/form-data" action="{% url 'career-apply' %}">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="applyModalLabel">
                        <i class="fas fa-briefcase me-2"></i>
                        Apply for <span id="jobTitleSpan" class="fw-bold">Position</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" name="job_title" id="jobTitleInput">
                    
                    <div class="form-floating mb-3">
                        <input type="text" name="name" id="name" class="form-control" placeholder="Enter your full name" required>
                        <label for="name">
                            <i class="fas fa-user me-2"></i>
                            Full Name
                        </label>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="email" name="email" id="email" class="form-control" placeholder="Enter your email" required>
                        <label for="email">
                            <i class="fas fa-envelope me-2"></i>
                            Email Address
                        </label>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="tel" name="phone" id="phone" class="form-control" placeholder="Enter your phone number">
                        <label for="phone">
                            <i class="fas fa-phone me-2"></i>
                            Phone Number
                        </label>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea name="message" id="message" class="form-control" style="height: 120px;" placeholder="Tell us why you're perfect for this role..."></textarea>
                        <label for="message">
                            <i class="fas fa-comment me-2"></i>
                            Cover Letter / Message
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-file-upload me-2"></i>
                            Resume / CV
                        </label>
                        <div class="file-upload-wrapper" id="fileUploadWrapper">
                            <div class="file-upload-content">
                                <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                <div class="file-upload-text">Drag & drop your resume here</div>
                                <div class="file-upload-subtext">or click to browse (PDF, DOC, DOCX - Max 5MB)</div>
                                <input type="file" name="resume" id="resume" class="file-upload-input" accept=".pdf,.doc,.docx">
                            </div>
                            <div class="file-selected" id="fileSelected">
                                <i class="fas fa-check-circle"></i>
                                <span id="fileName"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="btn-text">Send Application</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Enhanced Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="careerToast" class="toast toast-custom" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body d-flex align-items-center" id="careerToastBody">
            <i class="fas fa-check-circle toast-icon me-2"></i>
            <span>Application sent successfully!</span>
        </div>
    </div>
</div>
<!-- Video Banner -->
{% if video_banner %}
<section class="video-wrapper section-padding bg-img"
         data-overlay-dark="4"
         style="min-height: 450px;"
         data-background="{% if video_banner.video_image_cover %}{{ video_banner.video_image_cover.url }}{% else %}{% static 'img/banner/01.jpg' %}{% endif %}">

    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-md-12 text-center rotatex">
                
                {% if video_banner.video_file %}
                    <a href="{{ video_banner.video_file.url }}" data-lity="video" class="rotate-box vid">
                {% elif video_banner.video_url %}
                    <a href="{{ video_banner.video_url }}" data-lity="video" class="rotate-box vid">
                {% else %}
                    <a href="#" class="rotate-box vid">
                {% endif %}
                
                    <div class="rotate-circle rotate-text">
                        <svg class="textcircle" viewBox="0 0 500 500">
                            <defs>
                                <path id="textcircle" d="M250,400 a150,150 0 0,1 0,-300a150,150 0 0,1 0,300Z"></path>
                            </defs>
                            <text>
                                <textPath xlink:href="#textcircle" textLength="900">
                                    {{ hotel.name|default:"Our Hotel" }}
                                </textPath>
                            </text>
                        </svg>
                    </div>
                    <span class="icon"><i class="fas fa-play"></i></span>
                </a>

            </div>
        </div>
    </div>

    <!-- video text -->
    <div class="video-text">{{ video_banner.title|default:"Videos" }}</div>
</section>
{% endif %}
{% endblock %}
{% block footer_content %}
<footer class="footer">
    <!-- top -->
    <div class="top">
        <div class="container">
            <div class="row">

                <!-- Hotel Info -->
                <div class="col-md-3 mb-30">
                    <div class="item">
                        <div class="logo">
                            {% if hotel.logo %}
                                <img src="{{ hotel.logo.url }}" alt="{{ hotel.name }}">
                            {% else %}
                                <img src="{% static 'img/logo.png' %}" alt="{{ hotel.name }}">
                            {% endif %}
                        </div>
                        <p>{{ hotel.slogan|default:"Your unforgettable stay starts here." }}</p>
                        <div class="social-icons">
                            <ul class="list-inline">
                                {% for link in hotel.social_links.all|slice:":4" %}
                                    <li>
                                        <a href="{{ link.url }}" target="_blank">
                                            <i class="fa-brands fa-{{ link.icon }}"></i>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li><small>No social links</small></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Contact Info -->
                <div class="col-md-3 mb-30">
                    <div class="item">
                        <h3>Contact us</h3>
                        <p>{{ hotel.address|default:"Block 19 In front of، Katameya Heights, Cairo 11861" }}</p>
                        <div class="phone"><a href="tel:{{ hotel.phone|default:'+1235678910' }}">{{ hotel.phone|default:'+1 123 567 8910' }}</a></div>
                        <div class="mail"><a href="mailto:{{ hotel.email|default:'info@triumphhotel.com' }}">{{ hotel.email|default:'info@triumphhotel.com' }}</a></div>
                    </div>
                </div>

                <!-- Newsletter -->
                <div class="col-md-3 mb-30">
                    <div class="item">
                        <h3>Subscribe</h3>
                        <p>Want to stay informed? Subscribe to our newsletter.</p>
                        <div class="newsletter">
                            <form action="{% url 'subscribe-newsletter' %}" method="post">
                                {% csrf_token %}
                                <input type="email" name="email" placeholder="Email Address" required>
                                <button type="submit"><i class="fa-light fa-arrow-right"></i></button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- App Store Buttons -->
                <div class="col-md-3 mb-30">
                    <div class="item text-center">
                        <h3>Our App</h3>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="me-3">
                                <img src="{% static 'img/mobile-app.png' %}" alt="Our App" style="max-width: 80px;">
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <a href="https://apps.apple.com" target="_blank">
                                    <img src="{% static 'img/Download_on_the_App_Store_Badge_US-UK_RGB_blk_092917.svg' %}" alt="App Store" style="width: 170px; height: auto;">
                                </a>
                                <a href="https://play.google.com/store" target="_blank">
                                    <img src="{% static 'img/GetItOnGooglePlay_Badge_Web_color_English.png' %}" alt="Play Store" style="height: 50px;">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- bottom -->
    <div class="bottom">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-12">
                    <div class="links">
                        <ul>
                            <li><a href="{% url 'hotel-detail' hotel.slug %}">Home</a></li>
                            <li><a href="{% url 'about-page' hotel_slug=hotel.slug %}">About</a></li>
                            <li><a href="{% url 'hotel-facilities-page' hotel_slug=hotel.slug %}">Services</a></li>
                            <li><a href="{% url 'contact-page' hotel_slug=hotel.slug %}">Contact</a></li>
                            <li><a href="{% url 'faqs-page' hotel_slug=hotel.slug %}">FAQs</a></li>
                            <li><a href="{% url 'careers-page' hotel_slug=hotel.slug %}">Careers</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 text-end">
                    <p>© 2025 <a href="https://www.triumphhotel.com">Triumph Hotels Egypt</a></p>
                </div>
            </div>
        </div>
    </div>
</footer>
{% endblock %}
{% block script %}
<script>
  // Enhanced Career Modal JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('careerForm');
    const fileInput = document.getElementById('resume');
    const fileWrapper = document.getElementById('fileUploadWrapper');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const jobTitleSpan = document.getElementById('jobTitleSpan');
    const jobTitleInput = document.getElementById('jobTitleInput');

    // Initialize modal events
    initializeModalEvents();
    initializeFileUpload();
    initializeFormValidation();
    initializeFormSubmission();

    function initializeModalEvents() {
        // Reset form when modal is shown
        const modal = document.getElementById('applyModal');
        modal.addEventListener('show.bs.modal', function(event) {
            resetForm();
            
            // Get the job title from the clicked button
            const button = event.relatedTarget;
            if (button && button.dataset.jobTitle) {
                const jobTitle = button.dataset.jobTitle;
                jobTitleSpan.textContent = jobTitle;
                jobTitleInput.value = jobTitle;
            }
        });

        // Apply button click handlers (for job cards)
        document.querySelectorAll('[data-job-title]').forEach(button => {
            button.addEventListener('click', function() {
                const jobTitle = this.getAttribute('data-job-title');
                jobTitleSpan.textContent = jobTitle;
                jobTitleInput.value = jobTitle;
            });
        });
    }

    function initializeFileUpload() {
        // Drag and drop events
        fileWrapper.addEventListener('dragover', handleDragOver);
        fileWrapper.addEventListener('dragleave', handleDragLeave);
        fileWrapper.addEventListener('drop', handleDrop);
        
        // File input change event
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Remove the click event from the wrapper
        fileWrapper.removeEventListener('click', function() {
            fileInput.click();
        });

        // Add click event only to the upload content area
        const uploadContent = fileWrapper.querySelector('.file-upload-content');
        if (uploadContent) {
            uploadContent.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.click();
            });
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        fileWrapper.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        fileWrapper.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        fileWrapper.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    }

    function handleFileSelect(file) {
        const allowedTypes = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        ];
        const maxSize = 5 * 1024 * 1024; // 5MB

        // Validate file type
        if (!allowedTypes.includes(file.type)) {
            showToast('Only PDF or Word documents are allowed.', 'error');
            clearFileInput();
            return;
        }

        // Validate file size
        if (file.size > maxSize) {
            showToast('File size must be less than 5MB.', 'error');
            clearFileInput();
            return;
        }

        // Show selected file
        fileName.textContent = file.name;
        fileSelected.style.display = 'block';
        
        // Add success styling to wrapper
        fileWrapper.style.borderColor = 'var(--success-green)';
        fileWrapper.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
    }

    function clearFileInput() {
        fileInput.value = '';
        fileSelected.style.display = 'none';
        fileWrapper.style.borderColor = 'var(--neutral-medium)';
        fileWrapper.style.backgroundColor = '';
    }

    function initializeFormValidation() {
        // Real-time validation
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', function() {
                validateField(this);
            });

            input.addEventListener('blur', function() {
                validateField(this);
            });

            // Clear validation on focus
            input.addEventListener('focus', function() {
                this.classList.remove('is-invalid');
                const feedback = this.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = '';
                }
            });
        });
    }

    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        let isValid = true;
        let errorMessage = '';

        // Remove previous validation classes
        field.classList.remove('is-invalid');
        
        // Required field validation
        if (field.hasAttribute('required') && !value) {
            isValid = false;
            errorMessage = 'This field is required.';
        }
        
        // Email validation
        else if (fieldName === 'email' && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address.';
            }
        }
        
        // Phone validation for Egyptian numbers
        else if (fieldName === 'phone' && value) {
            // Remove any spaces, dashes, or parentheses
            const cleanNumber = value.replace(/[\s\-\(\)]/g, '');
            // Egyptian mobile number format: 01XXXXXXXXX (11 digits starting with 01)
            const phoneRegex = /^01[0125][0-9]{8}$/;
            
            // Only validate if the number is not empty
            if (cleanNumber && !phoneRegex.test(cleanNumber)) {
                isValid = false;
                errorMessage = 'Please enter a valid Egyptian mobile number (e.g., 01028688882)';
            }
        }

        // Update field validation state
        if (!isValid) {
            field.classList.add('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = errorMessage;
            }
        } else {
            // Remove invalid class if validation passes
            field.classList.remove('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = '';
            }
        }

        return isValid;
    }

    function validateForm() {
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        return isValid;
    }

    function initializeFormSubmission() {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                showToast('Please correct the errors in the form.', 'error');
                return;
            }

            submitForm();
        });
    }

    function submitForm() {
        const formData = new FormData(form);
        
        // Show loading state
        setLoadingState(true);

        // For Django integration, use the actual URL
        const submitUrl = form.action || "{% url 'career-apply' %}";
        
        fetch(submitUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            setLoadingState(false);
            
            if (data.success) {
                showToast('Application sent successfully!', 'success');
                resetForm();
                closeModal();
            } else {
                showToast(data.message || 'Failed to send application.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            setLoadingState(false);
            showToast('Something went wrong. Please try again.', 'error');
        });
    }

    function setLoadingState(loading) {
        if (loading) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div><span class="btn-text">Sending...</span>';
        } else {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span class="btn-text">Send Application</span>';
        }
    }

    function resetForm() {
        form.reset();
        clearFileInput();
        
        // Remove validation classes
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('is-invalid');
        });
        
        // Reset submit button
        setLoadingState(false);
    }

    function closeModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('applyModal'));
        if (modal) {
            modal.hide();
        }
    }

    function getCsrfToken() {
        const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
        return csrfInput ? csrfInput.value : '';
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('careerToast');
        const toastBody = document.getElementById('careerToastBody');
        const icon = toast.querySelector('.toast-icon');
        const messageSpan = toastBody.querySelector('span');
        
        // Reset classes
        toast.classList.remove('toast-success', 'toast-error');
        
        // Set content and style based on type
        if (type === 'success') {
            toast.classList.add('toast-success');
            icon.className = 'fas fa-check-circle toast-icon';
        } else {
            toast.classList.add('toast-error');
            icon.className = 'fas fa-exclamation-circle toast-icon';
        }
        
        messageSpan.textContent = message;
        
        // Show toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 4000
        });
        bsToast.show();
    }

    // Public methods for external use
    window.CareerModal = {
        show: function(jobTitle) {
            if (jobTitle) {
                document.getElementById('jobTitleSpan').textContent = jobTitle;
                document.getElementById('jobTitleInput').value = jobTitle;
            }
            const modal = new bootstrap.Modal(document.getElementById('applyModal'));
            modal.show();
        },
        
        hide: function() {
            closeModal();
        },
        
        showToast: showToast
    };
});

// Legacy support for existing code
function showToast(message, isError = false) {
    if (window.CareerModal) {
        window.CareerModal.showToast(message, isError ? 'error' : 'success');
    }
}
</script>
{% endblock %}
